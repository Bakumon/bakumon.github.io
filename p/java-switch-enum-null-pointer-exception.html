<!DOCTYPE html><html lang="zh-CN"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-93920714-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-93920714-1'); </script><title>switch enum 导致的空指针异常 | 食梦兽(BAKUMON)</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="switch enum 导致的空指针异常" /><meta name="author" content="Bakumon" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="今天遇到了一个不太常见的空指针异常，特此记录下来…当看到这个异常时，第一反应是 ordinal() 是什么方法？我没调用过啊？？？冷静下来通过报错位置的提示，发现异常出现在 switch(enum) 语句上" /><meta property="og:description" content="今天遇到了一个不太常见的空指针异常，特此记录下来…当看到这个异常时，第一反应是 ordinal() 是什么方法？我没调用过啊？？？冷静下来通过报错位置的提示，发现异常出现在 switch(enum) 语句上" /><link rel="canonical" href="https://bakumon.me/p/java-switch-enum-null-pointer-exception.html" /><meta property="og:url" content="https://bakumon.me/p/java-switch-enum-null-pointer-exception.html" /><meta property="og:site_name" content="食梦兽(BAKUMON)" /><meta property="og:image" content="https://i.loli.net/2021/07/16/LZziY7JkXeRBpsN.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-07-15T00:00:00+00:00" /> <script type="application/ld+json"> {"description":"今天遇到了一个不太常见的空指针异常，特此记录下来…当看到这个异常时，第一反应是 ordinal() 是什么方法？我没调用过啊？？？冷静下来通过报错位置的提示，发现异常出现在 switch(enum) 语句上","@type":"BlogPosting","url":"https://bakumon.me/p/java-switch-enum-null-pointer-exception.html","headline":"switch enum 导致的空指针异常","dateModified":"2021-07-15T00:00:00+00:00","datePublished":"2021-07-15T00:00:00+00:00","image":"https://i.loli.net/2021/07/16/LZziY7JkXeRBpsN.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://bakumon.me/p/java-switch-enum-null-pointer-exception.html"},"author":{"@type":"Person","name":"Bakumon"},"@context":"https://schema.org"}</script><link href="../app.css" rel="stylesheet"><header class="header"><div class="wrap"> <a href="/" class="header__title"> Bakumon </a><div class="menu" id="menu"><div class="menu__toggle" id="js-menu-toggle"><div class="menu__toggle__icon"><span></span></div></div><div class="menu__wrap"><ul class="menu__list"><li class="menu__list__item"> <a href="/" class="menu__list__item__link">首页</a><li class="menu__list__item"> <a href="/about.html" class="menu__list__item__link">关于</a><li class="menu__list__item"> <a href="/products.html" class="menu__list__item__link">作品</a><li class="menu__list__item"> <a href="/dreams.html" class="menu__list__item__link">梦境</a></ul></div></div></div></header><script> document.getElementById("js-menu-toggle").onclick = clickToggle; function clickToggle() { var menu = document.getElementById("menu"); var isOpen = menu.classList.contains("menu--open"); if(isOpen) { menu.classList.remove("menu--open"); } else { menu.classList.add("menu--open"); } } </script><div class="page__title"><div class="wrap"><h1>switch enum 导致的空指针异常</h1><p><time datetime="2021-07-15">2021-07-15</time></p></div></div><div class="image-wrap"> <img src="https://i.loli.net/2021/07/16/LZziY7JkXeRBpsN.png" /></div><div class="wrap single"><p>今天遇到了一个不太常见的空指针异常，特此记录下来。</p><h2 id="nullpointerexception">NullPointerException</h2><p>异常如下：</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Fatal Exception: java.lang.NullPointerException
Attempt to invoke virtual method 'int java.lang.Enum.ordinal()' on a null object reference
</code></pre></div></div><p>当看到这个异常时，第一反应是 ordinal() 是什么方法？我没调用过啊？？？</p><p>冷静下来通过报错位置的提示，发现异常出现在 switch(enum) 语句上。我们用以下示例代码说明：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 定义枚举类</span>
<span class="kd">private</span> <span class="kd">enum</span> <span class="nc">Position</span> <span class="o">{</span> 
  <span class="no">TOP</span><span class="o">,</span> <span class="no">BOTTOM</span>
<span class="o">}</span>

<span class="c1">// 声明 Position 变量，用于记录控制类型</span>
<span class="kd">private</span> <span class="nc">Position</span> <span class="n">mPosition</span><span class="o">;</span>

<span class="c1">// foo 方法中对控制类型进行判断</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">foo</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">switch</span><span class="o">(</span><span class="n">mPosition</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nl">TOP:</span>
      <span class="n">print</span><span class="o">(</span><span class="s">"TOP"</span><span class="o">);</span>
      <span class="k">break</span><span class="o">;</span>
    <span class="k">case</span> <span class="nl">BOTTOM:</span>
      <span class="n">print</span><span class="o">(</span><span class="s">"BOTTOM"</span><span class="o">);</span>
      <span class="k">break</span><span class="o">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">print</span><span class="o">(</span><span class="s">"不是 TOP 也不是 BOTTOM"</span><span class="o">);</span>
      <span class="k">break</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h2 id="异常原因分析">异常原因分析</h2><p>以上代码首先定义了一个表示 <strong>位置类型</strong> 的枚举类 Position，它有两个类型： TOP 和 BOTTOM。接着声明一个成员变量 mPosition，用来记录位置类型，每当位置改变时，就更新它的值。最后在一个方法里利用 switch 语句判断出位置类型的不同来执行不同的逻辑。</p><p>当我们还没有给 mPosition 赋值时，希望执行 foo() 方法打印 <code class="highlighter-rouge">不是 TOP 也不是 BOTTOM</code>，但实际上当执行到 switch(mPosition) 就报出了上面所说的空指针异常。</p><p>这是为什么呢？原来 switch 语句判断的对象是不能为 null 的，这时候 mPosition 还没有被赋值，是空的，所以就出现了空指针异常。</p><p><strong>但是为什么空指针会发生在调用 ordinal() 方法时？</strong></p><p>我们知道早期的 switch 语句只支持基本类型，从 Java 1.5 才开始支持 String 类型，但是还没有支持其他引用类型。枚举其实是一种特殊的类，也就是引用类型，我们却可以把枚举用在 switch 语句中，这显然是矛盾的。</p><p>这个矛盾的根源来自于 JVM。JVM 为了让 switch 语句支持枚举，当发现 switch 语句判断的是枚举时，会调用枚举对象的 ordinal() 方法，这个方法返回 int 值（表示顺序），用 int 来判断，这就回到了基本类型。</p><p>所以我们看到了空指针异常发生在 <code class="highlighter-rouge">int java.lang.Enum.ordinal()</code> 调用时。</p><h2 id="如何避免">如何避免</h2><p>在使用 switch 语句判断 String 或 enum 时，一定要保证值不能为空，上面的示例代码中，我们为了保证 mPosition 不为空，可以在声明时就初始化值，如果初始值是 TOP 或 BOTTOM 都不合适的话，可以加一种枚举类型（如 NONE）作初始值，同时也表示没有位置类型。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">enum</span> <span class="nc">Position</span> <span class="o">{</span> 
  <span class="no">TOP</span><span class="o">,</span> <span class="no">BOTTOM</span><span class="o">,</span> <span class="no">NONE</span>
<span class="o">}</span>
<span class="c1">// 初始化赋值</span>
<span class="kd">private</span> <span class="nc">Position</span> <span class="n">mPosition</span> <span class="o">=</span> <span class="no">NONE</span><span class="o">;</span>
</code></pre></div></div><p>这样就保证初始时不为 null 了，并且后续赋值时，也要避免赋空值。</p><div class="post__footer"><div class="article_tags"> <a href="/tag/Java" class="article_tag">Java</a></div><div class="post__share"> 分享： <a href="https://twitter.com/intent/tweet?text=switch enum 导致的空指针异常&url=https://bakumon.me/p/java-switch-enum-null-pointer-exception.html" target="_blank">Twitter</a></div></div><div class="comment" ><div id="cusdis_thread" data-host="https://cusdis.com" data-app-id="8929c900-d1c2-4fc8-aead-868e9b1ba53c" data-page-id="KEY_J78W7W382R" data-page-url="https://bakumon.me/p/java-switch-enum-null-pointer-exception.html" data-page-title="switch enum 导致的空指针异常"> <script defer src="https://cusdis.com/js/widget/lang/zh-cn.js"></script> <script defer src="https://cusdis.com/js/cusdis.es.js"></script></div></div><footer class="footer "><div class="wrap"> <a href="/" class="footer__title"> Bakumon </a><p class="footer__text">关于代码、梦境和一切。</p><div class="footer__copyright"> <span>© Bakumon</span> <span> ‧ Powered by Jekyll</span></div><ul class="socials"><li class="socials__item"> <a href="http://github.com/Bakumon" target="_blank" class="socials__item__link" title="Github"> <svg width='24' height='24' viewBox='0 0 512 512'><path fill="currentColor" d='M256,32C132.3,32,32,134.9,32,261.7c0,101.5,64.2,187.5,153.2,217.9a17.56,17.56,0,0,0,3.8.4c8.3,0,11.5-6.1,11.5-11.4,0-5.5-.2-19.9-.3-39.1a102.4,102.4,0,0,1-22.6,2.7c-43.1,0-52.9-33.5-52.9-33.5-10.2-26.5-24.9-33.6-24.9-33.6-19.5-13.7-.1-14.1,1.4-14.1h.1c22.5,2,34.3,23.8,34.3,23.8,11.2,19.6,26.2,25.1,39.6,25.1a63,63,0,0,0,25.6-6c2-14.8,7.8-24.9,14.2-30.7-49.7-5.8-102-25.5-102-113.5,0-25.1,8.7-45.6,23-61.6-2.3-5.8-10-29.2,2.2-60.8a18.64,18.64,0,0,1,5-.5c8.1,0,26.4,3.1,56.6,24.1a208.21,208.21,0,0,1,112.2,0c30.2-21,48.5-24.1,56.6-24.1a18.64,18.64,0,0,1,5,.5c12.2,31.6,4.5,55,2.2,60.8,14.3,16.1,23,36.6,23,61.6,0,88.2-52.4,107.6-102.3,113.3,8,7.1,15.2,21.1,15.2,42.5,0,30.7-.3,55.5-.3,63,0,5.4,3.1,11.5,11.4,11.5a19.35,19.35,0,0,0,4-.4C415.9,449.2,480,363.1,480,261.7,480,134.9,379.7,32,256,32Z' /> </svg> </a><li class="socials__item"> <a href="https://t.me/Bakumon" target="_blank" class="socials__item__link" title="Telegram"> <svg viewBox="0 0 1024 1024" width="20" height="20"><path fill="currentColor" d="M957.4 197.2l-135.2 637.6c-10.2 45-36.8 56.2-74.6 35l-206-151.8-99.4 95.6c-11 11-20.2 20.2-41.4 20.2l14.8-209.8 381.8-345c16.6-14.8-3.6-23-25.8-8.2L299.6 568 96.4 504.4c-44.2-13.8-45-44.2 9.2-65.4L900.4 132.8c36.8-13.8 69 8.2 57 64.4z"> </path> </svg> </a><li class="socials__item"> <a href="/feed.xml" target="_blank" class="socials__item__link" title="RSS"> <svg viewBox="0 0 1024 1024" width="20" height="20"><path fill="currentColor" d="M329.142857 768q0 45.714286-32 77.714286t-77.714286 32-77.714286-32-32-77.714286 32-77.714286 77.714286-32 77.714286 32 32 77.714286zm292.571429 70.285714q1.142857 16-9.714286 27.428571-10.285714 12-26.857143 12l-77.142857 0q-14.285714 0-24.571429-9.428571t-11.428571-23.714286q-12.571429-130.857143-105.428571-223.714286t-223.714286-105.428571q-14.285714-1.142857-23.714286-11.428571t-9.428571-24.571429l0-77.142857q0-16.571429 12-26.857143 9.714286-9.714286 24.571429-9.714286l2.857143 0q91.428571 7.428571 174.857143 46t148 103.714286q65.142857 64.571429 103.714286 148t46 174.857143zm292.571429 1.142857q1.142857 15.428571-10.285714 26.857143-10.285714 11.428571-26.285714 11.428571l-81.714286 0q-14.857143 0-25.428571-10t-11.142857-24.285714q-6.857143-122.857143-57.714286-233.428571t-132.285714-192-192-132.285714-233.428571-58.285714q-14.285714-0.571429-24.285714-11.142857t-10-24.857143l0-81.714286q0-16 11.428571-26.285714 10.285714-10.285714 25.142857-10.285714l1.714286 0q149.714286 7.428571 286.571429 68.571429t243.142857 168q106.857143 106.285714 168 243.142857t68.571429 286.571429z"> </path> </svg> </a></ul></div></footer>
